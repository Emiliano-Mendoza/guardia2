<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="plantilla/template :: head">
</head>
<body>

	<header th:replace="plantilla/template :: header"></header>

	<div> <?php echo "Hello World" ?> </div>
	
	<div class="container mt-3">
		
		<h5>Buscar Empleado:</h5>
		<div class="row mt-2">
			<div class="col-md-11">
				<input type="text" id="formulario" class="form-control">
			</div>
			<div class="col-md-1 ">
				<button class="btn btn-primary" onclick="filtrar()">Buscar</button>
			</div>
				
		</div>
		<div class="row mt-3" id="cardEgreso"></div>

		 
	</div>

	<div class="mt-5"></div>

	<footer th:replace="plantilla/template ::footer"></footer>

	<script th:inline="javascript">
		
		var asistencias = /*[[${asistencias}]]*/ 'default';
		var listaVehiculos = /*[[${listaVehiculos}]]*/ 'default';
		
		const formulario = document.querySelector('#formulario');
		const resultado = document.querySelector('#cardEgreso');
		
		const filtrar = () => {
			
			
				resultado.innerHTML = ''
					
					const texto = formulario.value.toLowerCase();
					
					for(let aut of asistencias){
						let nombre = aut.personal.nombre.toLowerCase();
						let apellido = aut.personal.apellido.toLowerCase();
						
						if(nombre.indexOf(texto) !== -1 || apellido.indexOf(texto) !== -1){
														
							let imagenEmpleado= `/recursos/${aut.personal.imagen}` ;
							let idFoo= `foo${aut.personal.nroLegajo}`;							
						
							//le doy el formato correcto a la fecha
							let d = new Date(aut.entrada);
							dformat = [d.getDate(),
				  				d.getMonth()+1,
				               d.getFullYear()].join('/')+' '+
				              [d.getHours(),
				               d.getMinutes()].join(':');
							
							if(!aut.enTransito){
								
								let urlEgreso= '/views/asistencia/egreso-empleado/' + aut.idAsistencia;
								let urlEgresoTransitorio= '/views/asistencia/egreso-transitorio/' + aut.idAsistencia;
								let idDiv = 'vehiculo' + aut.personal.nroLegajo; 
								let idForm = 'idForm' + aut.personal.nroLegajo;
								let idButtonEgreso = 'idButtonEgreso' + aut.personal.nroLegajo;
								let idCancelarButton = 'idCancelarButton' + aut.personal.nroLegajo;
								let idConfirmarButton = 'idConfirmarButton' + aut.personal.nroLegajo;
								let idEgresoTransitorio = 'idEgresoTransitorio' + aut.personal.nroLegajo;

								
								resultado.innerHTML += `
									<div class="col-sm-6 mt-3">
									<div class="card text-dark  mb-3" >
									<div class="card-header bg-dark text-white">Registro de Egreso
									de la Planta</div>
									<div class="row g-0 ">
										<div class="col-md-4" >
											<img src=${imagenEmpleado}
												id=${idFoo}
												style="max-width: 100%; height: auto"
												onerror="this.onerror=null;this.src='/images/anonimo.jpg';">
										</div>
										<div class="card-body col-md-8">
											<h5 class="card-title">Empleado ingresado:</h5>
											
											<ul class="list-group list-group-flush">
											  <li class="list-group-item">Empleado: ${aut.personal.nombre}
												${aut.personal.apellido}</li>
											  <li class="list-group-item">Número de legajo: ${aut.personal.nroLegajo}</li>
											  <li class="list-group-item">Sector de trabajo: ${aut.personal.sector}</li>
											  <li class="list-group-item">Fecha y hora del ingreso: ${dformat}</li>
											  <li id=${idDiv} class="list-group-item"></li>
											</ul>
											
											
																						
										</div>
									</div>
									
									<div
									class="card-footer bg-dark d-grid gap-2 d-md-flex justify-content-md-end">
									<form 
										action=${urlEgresoTransitorio}
										object=${aut}
										method="post"  
										onsubmit="return confirm('Confirmar egreso transitorio del empleado ${aut.personal.nombre} ${aut.personal.apellido} ?');"
										id=${idForm}>									
											
											<button type="button" class="btn btn-secondary btn-sm"
											id=${idCancelarButton}
											onclick="filtrar()"
											hidden>Cancelar</button>
										
											<button type="button" class="btn btn-secondary btn-sm" 
											onclick="mostrarListaVehiculos('${idDiv}','${idForm}','${idButtonEgreso}','${idCancelarButton}','${idEgresoTransitorio}','${idConfirmarButton}')"		
											id=${idEgresoTransitorio}
											>Egreso Transitorio</button>
										
											<input type="submit" class="btn btn-secondary btn-sm"
												id=${idConfirmarButton} hidden
												value="Confirmar" />
												
									</form>
									<form 
									action=${urlEgreso}
									object=${aut}
									method="post"  
										onsubmit="return confirm('Confirmar egreso del empleado ${aut.personal.nombre} ${aut.personal.apellido} ?');">
									
										<input type="submit" class="btn btn-primary btn-sm"
											id=${idButtonEgreso}
											value="Registrar Egreso" />
									
									</form>
									
									</div>
									
								</div>
								</div>
								`;
								
								//------------------	
							}else{
								
								let urlReingresoTransitorio= '/views/asistencia/reingreso-transitorio/' + aut.idAsistencia;								
								
								resultado.innerHTML += `
									<div class="col-sm-6 mt-3">
									<div class="card text-dark mb-3" >
									<div class="card-header bg-dark text-white">Registro de Egreso
									de la Planta</div>
									<div class="row g-0 ">
										<div class="col-md-4">
											<img src=${imagenEmpleado}
												id=${idFoo}
												style="max-width: 100%; height: auto;"
												onerror="this.onerror=null;this.src='/images/anonimo.jpg';">
										</div>
										<div class="card-body col-md-8">
											<h5 class="card-title">Empleado en tránsito:</h5>
											
											<ul class="list-group list-group-flush">
											  <li class="list-group-item">Empleado: ${aut.personal.nombre}
												${aut.personal.apellido}</li>
											  <li class="list-group-item">Número de legajo: ${aut.personal.nroLegajo}</li>
											  <li class="list-group-item">Sector de trabajo: ${aut.personal.sector}</li>
											  <li class="list-group-item">Fecha y hora del ingreso: ${dformat}</li>
											</ul>
											
										</div>
									</div>
									
									<div
									class="card-footer bg-dark d-grid gap-2 d-md-flex justify-content-md-end">
									<form 
										action=${urlReingresoTransitorio}
										object=${aut}
										method="post"  
											onsubmit="return confirm('Confirmar reingreso del empleado ${aut.personal.nombre} ${aut.personal.apellido} ?');">
										
											<input type="submit" class="btn btn-secondary btn-sm"
												value="Reingreso" />
										
									</form>
									
									</div>
									
								</div>
								</div>
								`;
							}
							
							
						
					}
			}			
		}
		

		
		function mostrarListaVehiculos(idDiv, idForm, idButtonEgreso, idCancelarButton, idEgresoTransitorio, idConfirmarButton){
						
			const divVehiculos = document.getElementById(idDiv);
			document.getElementById(idButtonEgreso).hidden = true;
			document.getElementById(idCancelarButton).hidden = false;
			document.getElementById(idEgresoTransitorio).hidden = true;
			document.getElementById(idConfirmarButton).hidden = false;
			
			idSelect = idDiv +'111';
			
			divVehiculos.innerHTML = `
				<label>Vehiculo a utilizar:</label>
				<select name="vehiculo" form=${idForm} class="form-select mt-2" id=${idSelect} forEach>
				<option value="-1">Sin vehiculo</option>
				</select>
			`;
			
			const mySelect = document.getElementById(idSelect);
			
			listaVehiculos.forEach(v => mySelect.innerHTML+=`<option value=${v.idVehiculo}>${v.marca} ${v.modelo} - Patente: ${v.patente}</option>`);
					
		}
				
		formulario.addEventListener('keyup', function(event) {
		    event.preventDefault();
		    if (event.keyCode === 13) {
		        filtrar();
		    }
		});
		
		
		filtrar();
		
	</script>

</body>
</html>