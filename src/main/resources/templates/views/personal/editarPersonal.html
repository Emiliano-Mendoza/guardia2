<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="plantilla/template :: head">
</head>
<body>

	<header th:replace="plantilla/template :: header"></header>

	<div class="container">
	
		<div class="row mt-3 d-grid gap-2 d-md-flex justify-content-md-center" id="cardEditar"></div>
	
		<h3 class="mt-3">Buscar Empleado: </h3>
		
		<input type="text" id="formulario" class="form-control">
		<table class="table" style="width: 100%">
			<thead>
				<tr>
					
					<th class="sortable" scope="col" style="width: 15%; text-align: center;">Legajo</th>
					<th class="sortable" scope="col" style="width: 20%; text-align: center;">Nombre</th>
					<th class="sortable" scope="col" style="width: 20%; text-align: center;">Apellido</th>
					<th class="sortable" style="width: 20%; text-align: center;">Sector</th>
					<th scope="col" style="width: 25%; text-align: center;">Editar Empleado</th>
				</tr>
			</thead>
			<tbody id="fila">

			</tbody>
		</table>
	</div>

	<div class="mt-5"></div>

	<footer th:replace="plantilla/template ::footer"></footer>
	
	<script th:inline="javascript"> 
	
		var personal = /*[[${listaPersonal}]]*/ 'default';
		
		const formulario = document.querySelector('#formulario');
		const resultado = document.querySelector('#fila')
		const cardEditar = document.getElementById('cardEditar');
		
		const filtrar = () => {
			resultado.innerHTML = '';
			
			const texto = formulario.value.toLowerCase();
			for(let p of personal){
				let nombre = p.nombre.toLowerCase();
				let apellido = p.apellido.toLowerCase();
				let legajo = p.nroLegajo;
					
				if(nombre.indexOf(texto) !== -1 || apellido.indexOf(texto) !== -1){				
					
					resultado.innerHTML += `
					<tr>
						<td scope="row" style="text-align:center;">${p.nroLegajo}</td>
						<td style="text-align:center;">${p.nombre}</td>
						<td style="text-align:center;">${p.apellido}</td>
						<td style="text-align:center;">${p.sector}</td>						
						<td style="text-align:center;">
							<button class="btn btn-success btn-sm" 
							title:"Registrar Nueva Asistencia" id="asisBtn" 
							onclick="editarEmpleado('${p.nroLegajo}','${p.nombre}','${p.apellido}','${p.sector}','${p.imagen}')">
							Editar
							</button>
						</td>
					</tr>
					`
				}
			}
		}
		
		
		//
		function sortTable(selector, compFunc) {
		      var mySelector = '.sortable';
		      var myCompFunc = function($td1, $td2, isAsc) {
		        var v1 = $.trim($td1.text()).replace(/,|\s+|%/g, '');
		        var v2 = $.trim($td2.text()).replace(/,|\s+|%/g, '');
		        var pattern = /^\d+(\.\d*)?$/;
		        if (pattern.test(v1) && pattern.test(v2)) {
		          v1 = parseFloat(v1);
		          v2 = parseFloat(v2);
		        }
		
		        return isAsc ? v1 > v2 : v1 < v2;
		      };
		
		      var doSort = function($tbody, index, compFunc, isAsc)
		      {
		        var $trList = $tbody.find("tr");
		        var len = $trList.length;
		        for(var i=0; i<len-1; i++) {
		          for(var j=0; j<len-i-1; j++) {
		            var $td1 = $trList.eq(j).find("td").eq(index);
		            var $td2 = $trList.eq(j+1).find("td").eq(index);
		
		            if (compFunc($td1, $td2, isAsc)) {
		              var t = $trList.eq(j+1);
		              $trList.eq(j).insertAfter(t);
		              $trList = $tbody.find("tr");
		            }
		          }
		        }
	      	}
	
		      var init = function() {
		        var $th = $("th" + selector);
		        this.$table = $th.closest("table");
		        var that = this;
		        $th.click(function(){
		          var index = $(this).index();
		          var asc = $(this).attr('data-asc');
		          isAsc = asc === undefined ? true : (asc > 0 ? true : false);
		
		          doSort(that.$table.find("tbody"), index, compFunc, isAsc);
		
		          $(this).attr('data-asc', 1 - (isAsc ? 1 : 0));
		        });
		
		        $th.css({'cursor': 'pointer'})
		           .attr('title', 'Haga clic para ordenar')
		           .append('&nbsp;<i class="fa fa-long-arrow-down" style="color:#2196F3" aria-hidden="true"></i><i class="fa fa-long-arrow-up" style="color:#2196F3" aria-hidden="true"></i>');
		      };
	
	
	      selector = selector || mySelector;
	      compFunc = compFunc || myCompFunc;
	
	      init();
	    }
		//
	
		function editarEmpleado(nroLegajo, nombre, apellido, sector, imagen){
			
			let urlA = "/views/personal/editar/" + nroLegajo;		
			let imagenAux = imagen.replace(/\s/g, "%20");
			let imagenEmpleado= `/recursos/${imagenAux}` ;
			
			cardEditar.innerHTML = `
				<div class="col-md-8">
				
				<div class="card-header bg-dark text-white">Editar Empleado:</div>
			
				<form action=${urlA} method="post" autocomplete="off" enctype="multipart/form-data">
					
					
					<div class="card-body row">
						<div class="col-md-6">
							<div class="form-group">
								<label for="nombre">Número de legajo:</label> <input type="text"
									class="form-control" id="nombre" placeholder="Nombre"
									name="nroLegajo" required value=${nroLegajo} disabled>
							</div>
						</div>
	
						<div class="col-md-6">
							<div class="form-group">
								<label for="sector">Sector de trabajo:</label> <select class="form-select"
									name="sector" id="sector">
									
								</select>
							</div>
						</div>
					</div>
				
				
					<div class="card-body row">
						<div class="col-md-6">
							<div class="form-group">
								<label for="nombre">Nombre:</label> <input type="text"
									class="form-control" id="nombre" placeholder="Nombre"
									name="nombre" required value="${nombre}">
							</div>
						</div>

						<div class="col-md-6">
							<div class="form-group">
								<label for="apellido">Apellido:</label> <input type="text"
									class="form-control" id="apellido" placeholder="Apellido"
									name="apellido" required value="${apellido}">
							</div>
						</div>
					</div>
					
					<div class="card-body row">						
						<div class="form-group col-md-3 ">
							<label for="nombre">Imagen del empleado:</label>
							<img class="mt-2" src=${imagenEmpleado}
								width="160" height="160"
								onerror="this.onerror=null;this.src='/images/anonimo.jpg';">
						</div>
						
						<div class="form-group col-md-6 ">
						<label for="exampleFormControlFile1" style="display: block;">Cambiar imagen del empleado:</label> 
						<input type="file" name="file"
							class="form-control-file mt-2" id="file">
					</div>
					</div>

					<div
						class="card-footer bg-dark mt-3 d-grid gap-2 d-md-flex justify-content-between">
						<input type="button" class="btn btn-primary btn-sm" onclick="cancelarEdit()"
						value="Cancelar" />
						<input type="submit" class="btn btn-primary btn-sm"
							value="Confirmar" />
					</div>

				</form>


			</div>		

			`;
			
			selectedSector(sector);
			window.scroll(0, 0);
			
		}
		
		function cancelarEdit(){			
			cardEditar.innerHTML = '';		
		}
			
		function selectedSector(sector){
			
			let sectores = ["Administrativo","Almacenes","Ayud. Gral.",
							"Descartonado","Enfardado","Impresión","Informática",
							"Mantenimiento","Mantenimiento Electrico","Mantenimiento Mec",
							"Movimientos Internos","Oficina Tecnica","Pegadora",
							"Preprensa","Producción","Tintas","Troquelado","Otro"];
			
			const selector = document.getElementById("sector");
			
			for(let sec of sectores){
				
				if(sector == sec){
					selector.innerHTML += `
						<option value="${sec}" selected>${sec}</option>
					`;
				}else{
					selector.innerHTML += `
						<option value="${sec}">${sec}</option>
					`;
				}
			}
			
		} 
		
		
		formulario.addEventListener('keyup', filtrar);
		filtrar();
		sortTable();
		
		
	</script>
</body>
</html>