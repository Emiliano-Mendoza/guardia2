<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="plantilla/template :: head">
</head>
<body>
	<!-- th:href="@{/css/bootstrap.min.css}" -->

	<header th:replace="plantilla/template :: header"></header>

	<div class="container d-flex justify-content-center mt-3" id="cardAsis">

	</div>

	<div class="container">
		<h2>Listado del Personal:</h2>

		<input type="text" id="formulario" class="form-control">
		<table class="table" style="width: 100%">
			<thead>
				<tr>
					
					<th class="sortable" scope="col" style="width: 15%; text-align: center;">Legajo</th>
					<th class="sortable" scope="col" style="width: 20%; text-align: center;">Nombre</th>
					<th class="sortable" scope="col" style="width: 20%; text-align: center;">Apellido</th>
					<th class="sortable" style="width: 20%; text-align: center;">Sector</th>
					<th scope="col" style="width: 25%; text-align: center;">Registrar
						Asistencia</th>
				</tr>
			</thead>
			<tbody id="fila">

			</tbody>
		</table>
	</div>
	<div class="mt-5"></div>

	<footer th:replace="plantilla/template ::footer"></footer>

	<script th:inline="javascript"> 
		
		var personal = /*[[${personal}]]*/ 'default';
		// var link = /*[[@{/views/asistencia/empleado/}]]*/'';
		var urlAsis = '';
		
		
		const formulario = document.querySelector('#formulario');
		const resultado = document.querySelector('#fila');
		const cardAsis = document.querySelector('#cardAsis');
		cardAsis.innerHTML = '';
		
		//
		function sortTable(selector, compFunc) {
	      var mySelector = '.sortable';
	      var myCompFunc = function($td1, $td2, isAsc) {
	        var v1 = $.trim($td1.text()).replace(/,|\s+|%/g, '');
	        var v2 = $.trim($td2.text()).replace(/,|\s+|%/g, '');
	        var pattern = /^\d+(\.\d*)?$/;
	        if (pattern.test(v1) && pattern.test(v2)) {
	          v1 = parseFloat(v1);
	          v2 = parseFloat(v2);
	        }
	
	        return isAsc ? v1 > v2 : v1 < v2;
	      };
	
	      var doSort = function($tbody, index, compFunc, isAsc)
	      {
	        var $trList = $tbody.find("tr");
	        var len = $trList.length;
	        for(var i=0; i<len-1; i++) {
	          for(var j=0; j<len-i-1; j++) {
	            var $td1 = $trList.eq(j).find("td").eq(index);
	            var $td2 = $trList.eq(j+1).find("td").eq(index);
	
	            if (compFunc($td1, $td2, isAsc)) {
	              var t = $trList.eq(j+1);
	              $trList.eq(j).insertAfter(t);
	              $trList = $tbody.find("tr");
	            }
	          }
	        }
      }

      var init = function() {
        var $th = $("th" + selector);
        this.$table = $th.closest("table");
        var that = this;
        $th.click(function(){
          var index = $(this).index();
          var asc = $(this).attr('data-asc');
          isAsc = asc === undefined ? true : (asc > 0 ? true : false);

          doSort(that.$table.find("tbody"), index, compFunc, isAsc);

          $(this).attr('data-asc', 1 - (isAsc ? 1 : 0));
        });

        $th.css({'cursor': 'pointer'})
           .attr('title', 'Haga clic para ordenar')
           .append('&nbsp;<i class="fa fa-long-arrow-down" style="color:#2196F3" aria-hidden="true"></i><i class="fa fa-long-arrow-up" style="color:#2196F3" aria-hidden="true"></i>');
      };


      selector = selector || mySelector;
      compFunc = compFunc || myCompFunc;

      init();
    }
		//
		
				
		const filtrar = () => {
			resultado.innerHTML = '';
			
			
			
			const texto = formulario.value.toLowerCase();
			for(let p of personal){
				let nombre = p.nombre.toLowerCase();
				let apellido = p.apellido.toLowerCase();
				let legajo = p.nroLegajo;
				

				
				if(nombre.indexOf(texto) !== -1 || apellido.indexOf(texto) !== -1){
					
					
					
					resultado.innerHTML += `
					<tr>
						<td scope="row" style="text-align:center;">${p.nroLegajo}</td>
						<td style="text-align:center;">${p.nombre}</td>
						<td style="text-align:center;">${p.apellido}</td>
						<td style="text-align:center;">${p.sector}</td>						
						<td style="text-align:center;">
							<button class="btn btn-success btn-sm" 
							title:"Registrar Nueva Asistencia" id="asisBtn" 
							onclick="AsistenciaCard('${p.nroLegajo}','${p.nombre}','${p.apellido}','${p.sector}','${p.imagen}')">
							Asistencia
							</button>
						</td>
					</tr>
					`
					//<td ><img src="${imagePath}" style="width:70px;height:70px"></td>
				}
			}
		}
		
		
		function AsistenciaCard (nroLegajo,nombre,apellido,sector, imagen){
			
			let urlA = "/views/asistencia/ingreso-empleado/" + nroLegajo;
			//let imagenEmpleado= `/recursos/${imagen}` ;
			let imagenAux = imagen.replace(/\s/g, "%20");
			let imagenEmpleado= `/recursos/${imagenAux}` ;
			
			cardAsis.innerHTML = `
				<div class="card mb-3" style="max-width: 700px;">
				<div class="card-header bg-dark text-white ">Registro de Ingreso
					a la Planta</div>
				<div class="row g-0 ">
					<div class="col-md-4" id="imagen">
						<img src=${imagenEmpleado}
						style="max-width: 100%; height: auto;"
						onerror="this.onerror=null;this.src='/images/anonimo.jpg';">
					</div>
					<div class="col-md-8">
						<div class="card-body">
							<h5 class="card-title">Registrar asistencia:</h5>
							
							
							<ul class="list-group list-group-flush">
							  <li class="list-group-item">Empleado: ${nombre} ${apellido}</li>
							  <li class="list-group-item">NÃºmero de Legajo: ${nroLegajo}</li>
							  <li class="list-group-item">Sector de trabajo: ${sector}</li>
							  <li class="list-group-item">Fecha y hora del ingreso: <small class="text-muted"><span
								id='date-time'></span></small></li>
							</ul>
							
						</div>
					</div>
				</div>
				<form 	
						action=${urlA}
						method="post"
						onsubmit="return confirm('Confirmar asistencia del empleado ${nombre} ${apellido}');">
					<div
						class="card-footer bg-dark d-grid gap-2 d-md-flex justify-content-between">
						<button type="button" class="btn btn-secondary" onclick="CloseCard()"
							>Cancelar</button>
							<button type="submit" class="btn btn-secondary"
								>Registrar</button> 
							
					</div>
				</form>

			</div>
			`;
			
			//formato de la fecha
			var d = new Date,
  			dformat = [d.getDate(),
  				d.getMonth()+1,
               d.getFullYear()].join('/')+' '+
              [d.getHours(),
               d.getMinutes()].join(':');
			
			document.getElementById('date-time').innerHTML = dformat;
				
			window.scroll(0, 0);
		}
	

		
		function CloseCard(){
			cardAsis.innerHTML = '';
		}
		
		formulario.addEventListener('keyup', filtrar);
		filtrar();
		sortTable();
	</script>
</body>
</html>